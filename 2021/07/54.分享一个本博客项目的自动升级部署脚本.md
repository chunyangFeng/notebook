[TOC]

**本脚本仅供学习参考，不具备移植性，如果感兴趣，可以自行研究代码修改**

```Shell
#!/bin/bash
# Author: https://www.fengchunyang.com
# Date: 2021-06-08 15:19
# Version: v1.1


args=$1
now=$(date +'%Y%m%H%M%S')
rootPath='/mnt/product'

function printMsg() {
    if [ [$2 = "error"] ];then
        color=31
    else
        color=32
    fi
    echo -e "\033[1;$color;40m$1\033[0m"
}

function exitScript() {
    if [ $? -ne 0 ];then
        printMsg $1 "error"
        exit 1
    fi
}

function pullProject() {
    printMsg "开始拉取最新项目代码"
    cd $rootPath/tmp && git clone https://github.com/chunyangfeng/phoenix.git
    exitScript "命令执行失败，退出程序"
    printMsg "最新代码拉取完毕"
}

function backupSql() {
    printMsg "开始备份sql"
    mysqldump -uroot -p123456 --databases phoenix >$rootPath/backup/data/$now.sql
    exitScript "命令执行失败，退出程序"
    printMsg "sql备份完成"
}

function backupProject() {
    printMsg "开始备份项目目录并恢复配置文件"
    mv $rootPath/phoenix $rootPath/backup/project/phoenix$now
    mv $rootPath/tmp/phoenix $rootPath/
    /bin/cp -rpf $rootPath/config.py $rootPath/phoenix/phoenix/
    exitScript "命令执行失败，退出程序"
    printMsg "项目目录已备份，配置文件已恢复"
}

function migrateDb() {
    printMsg "迁移数据库"
    source $rootPath/venv/bin/activate && python $rootPath/phoenix/manage.py makemigrations --load && python $rootPath/phoenix/manage.py migrate && deactivate
    exitScript "命令执行失败，退出程序"
    printMsg "数据库迁移完成"
}

function controlProject() {
    case $1 in
        "start")
            printMsg "启动项目"
            source $rootPath/venv/bin/activate && uwsgi --ini $rootPath/phoenix/wsgi.ini && deactivate
            systemctl start nginx
            exitScript "命令执行失败，退出程序"
            printMsg "启动完成"
            ;;
        "stop")
            printMsg "停止项目"
            ps aux|grep uwsgi|grep -v grep|awk '{print $2}'|xargs -r kill -9
            systemctl stop nginx
            exitScript "命令执行失败，退出程序"
            printMsg "停止完成"
            ;;
        "restart")
            controlProject "stop"
            controlProject "start"
            ;;
        "*")
            printMsg "Error argument" "error"
            exit 1
            ;;
    esac
}

function controlCelery() {
    case $1 in
        "start")
            printMsg "开始启动celery"
            source $rootPath/venv/bin/activate && cd $rootPath/phoenix && celery -A phoenix worker --detach -l info -f $rootPath/celery/worker.log && deactivate
            printMsg "celery worker启动成功"
            source $rootPath/venv/bin/activate && cd $rootPath/phoenix && celery -A phoenix beat --detach -l info -f $rootPath/celery/beat.log && deactivate
            exitScript "命令执行失败，退出程序"
            printMsg "celery beat启动成功"
            printMsg "celery启动完成"
            ;;
        "stop")
            printMsg "开始停止celery"
            ps aux|grep celery|grep -v grep|awk '{print $2}'|xargs -r kill -9
            exitScript "命令执行失败，退出程序"
            printMsg "celery停止完成"
            ;;
        "restart")
            printMsg "重启celery"
            controlCelery "stop"
            controlCelery "start"
            ;;
        "*")
            printMsg "Error args" "error"
            exit 1
            ;;
    esac
}

function run() {
    pullProject
    backupSql
    backupProject 
    migrateDb
    controlProject "restart"
    controlCelery "restart"
}

run
```