#### 为什么要进行持久化

&ensp;&ensp;传统的关系型数据库，如MySQL，都是直接将数据存储在磁盘上的，写一条，存一条，只要不是在写入的过程中出现异常，基本上是不会出现数据丢失问题的，也不存在持久化问题。而Redis为了提升数据读取的效率，使用了速度最快的内存读写，使用内存可能存在的潜在风险之一，就是当系统意外宕机停止时，内存中的数据就会被清空。这样就会出现我们不希望出现的情况：数据丢失。

&ensp;&ensp;所谓的持久化(Persistence)，就是把内存中的数据保存在磁盘上，当Redis出现异常时，能通过保存在磁盘上的数据进行恢复。这样就能保证数据的完整性和可靠性。

#### 持久化的方式

&ensp;&ensp;Redis提供了两种持久化的方式，一种是RDB，一种是AOF。默认使用的是RDB模式。

##### RDB(Redis Database)

&ensp;&ensp;RDB持久化的策略，是通过指定的定时策略，对内存中的数据进行快照(Snapshot)存储，存储的数据在一个名为dump.rdb的二进制文件中。这是一个非常紧凑的文件，它保存了某个时间点的数据集，非常适用于对数据集的备份。比如你可以设置Redis每个小时保存一下当天的数据，每隔一天保存一下当月数据，这样就能让你非常方便的恢复指定时间点的数据。

&ensp;&ensp;在RDB进行保存时，由主进程```fork()```出一个子进程，子进程将数据集写入临时RDB文件，当子进程完成对新RDB文件的写入时，Redis就用新的RDB文件替换原来的RDB文件并删除旧的RDB文件，在这个过程中，所有的操作都是在子进程中完成的，父进程并不需要进行任何IO操作，因为RDB的持久化方式可以最大化Redis的性能，与AOF相比，在恢复比较大的数据集时，RDB方式会更快一点。

&ensp;&ensp;由于RDB是通过定时策略进行数据持久化，因此，无法应对系统意外宕机的情况。即使你将任务设置为每分钟执行一次，那么在意外来临的时候，你至少也会丢失一分钟的数据。而且RDB保存整个数据集的时候，任务也挺繁重的，如果执行频率过高，有可能会影响Redis的正常功能。

##### AOF(Append-Only file)

&ensp;&ensp;AOF在每次进行写操作时，都会将写指令追加到AOF文件中，当服务器重启的时候，Redis可以通过AOF文件中的写指令，重新创建整个数据集。

&ensp;&ensp;AOF文件是一个只进行追加的日志文件，类似于MySQL的Binlog。在AOF文件体积过大时，Redis还会在后台进行AOF的重写，重写后的AOF文件包含恢复当前数据集所需的最小命令集合。AOF文件有序的保存了对数据库进行的所有写操作，这些写操作以Redis协议的格式保存，因此非常易读，对文件进行分析也会变得相对容易。

&ensp;&ensp;对于相同的数据集来说，AOF文件会比RDB文件要大一些，数据的恢复速度也要慢一些。

#### 如何选择

&ensp;&ensp;如果你只是使用Redis进行数据缓存，对数据的可靠性并不关心的话，你甚至可以不开启任何持久化方式，因为这对你没有任何意义。

&ensp;&ensp;如果你希望Redis中的数据既要保证可靠性，又要保证完整性，那么你应该同时开启RDB和AOF，既能保证每一个时间点的数据集有效，又能防止意外宕机造成的数据丢失。在同时使用两种持久化方式时，Redis会优先使用AOF进行数据恢复。